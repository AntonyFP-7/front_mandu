<nz-layout class="main-layout">
  <!-- Header -->
  <nz-header class="app-header">
    <div class="header-content">
      <!-- Logo y Menús de navegación - Izquierda -->
      <div class="header-left">
        <!-- Logo -->
        <div class="logo">
          <span>MANDÜ</span>
        </div>

        <!-- Menús de navegación horizontales -->
        <ul nz-menu nzMode="horizontal" nzTheme="light" class="main-menu">
          <li
            nz-menu-item
            (click)="selectMenuItem('dashboard')"
            [class.menu-selected]="selectedMenuItem === 'dashboard'"
          >
            <span nz-icon nzType="dashboard"></span>
            <span>Dashboard</span>
          </li>

          <li
            nz-menu-item
            (click)="selectMenuItem('organization')"
            [class.menu-selected]="selectedMenuItem === 'organization'"
          >
            <span nz-icon nzType="apartment"></span>
            <span>Organización</span>
          </li>
        </ul>
      </div>

      <!-- Iconos y administrador - Derecha -->
      <div class="header-right">
        <!-- Iconos de mensajes y notificaciones -->
        <div class="header-icons">
          <nz-badge [nzCount]="messageCount" nzSize="small">
            <button nz-button nzType="text" nzSize="large" >
              <span nz-icon nzType="message" nzTheme="outline"></span>
            </button>
          </nz-badge>

          <nz-badge [nzCount]="notificationCount" nzSize="small">
            <button nz-button nzType="text" nzSize="large">
              <span nz-icon nzType="bell" nzTheme="outline"></span>
            </button>
          </nz-badge>
        </div>

        <!-- Dropdown del administrador -->
        <div
          class="admin-dropdown"
          nz-dropdown
          [nzDropdownMenu]="adminMenu"
          nzPlacement="bottomRight"
        >
          <div class="admin-info">
            <nz-avatar nzIcon="user" nzSize="small"></nz-avatar>
            <span class="admin-name">Administrador</span>
            <span nz-icon nzType="down"></span>
          </div>
        </div>

        <!-- Template del menú dropdown -->
        <nz-dropdown-menu #adminMenu="nzDropdownMenu">
          <ul nz-menu>
            <li nz-menu-item (click)="logout()">
              <span nz-icon nzType="logout"></span>
              <span>Cerrar Sesión</span>
            </li>
          </ul>
        </nz-dropdown-menu>
      </div>
    </div>
  </nz-header>

  <!-- Contenido principal -->
  <nz-content class="main-content">
    <div class="dashboard-container">
      <!-- Contenido según el menú seleccionado -->
      <div class="content-section">
        <!-- Dashboard Content -->
        <div *ngIf="selectedMenuItem === 'dashboard'" class="dashboard-content">
          <nz-card nzTitle="Lista de Divisiones" class="divisions-card">
            <!-- Encabezado con botón para crear nueva división -->
            <div nz-card-extra>
              <button nz-button nzType="primary" (click)="showCreateModal()">
                <span nz-icon nzType="plus"></span>
                Nueva División
              </button>
            </div>

            <!-- Sección de filtros -->
            <div class="filters-section">
              <div class="filters-container">
                <h4>Filtros de búsqueda</h4>
                <div class="filter-inputs">
                  <div class="filter-group">
                    <label>Nombre:</label>
                    <input
                      nz-input
                      placeholder="Buscar por nombre..."
                      [value]="filterName()"
                      (input)="onNameFilterChange($event.target.value)"
                      class="filter-input"
                    />
                  </div>
                  <div class="filter-group">
                    <label>Nivel:</label>
                    <nz-select
                      nzPlaceHolder="Seleccionar nivel"
                      nzAllowClear
                      [ngModel]="filterLevel()"
                      (ngModelChange)="onLevelFilterChange($event)"
                      class="filter-select"
                    >
                      <nz-option [nzValue]="1" nzLabel="Nivel 1"></nz-option>
                      <nz-option [nzValue]="2" nzLabel="Nivel 2"></nz-option>
                      <nz-option [nzValue]="3" nzLabel="Nivel 3"></nz-option>
                      <nz-option [nzValue]="4" nzLabel="Nivel 4"></nz-option>
                      <nz-option [nzValue]="5" nzLabel="Nivel 5"></nz-option>
                    </nz-select>
                  </div>
                  <div class="filter-actions">
                    <button nz-button nzType="default" (click)="clearFilters()">
                      <span nz-icon nzType="clear"></span>
                      Limpiar
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <nz-table #divisionsTable [nzData]="sortedDivisions() || []" nzSize="middle">
              <thead>
                <tr>
                  <th 
                    nzColumnKey="name" 
                    [nzSortOrder]="sortOrder.name" 
                    (nzSortOrderChange)="sort('name', $event)"
                    [nzSortDirections]="sortDirections"
                  >
                    División
                  </th>
                  <th 
                    nzColumnKey="parent" 
                    [nzSortOrder]="sortOrder.parent" 
                    (nzSortOrderChange)="sort('parent', $event)"
                    [nzSortDirections]="sortDirections"
                  >
                    División superior
                  </th>
                  <th 
                    nzColumnKey="employees" 
                    [nzSortOrder]="sortOrder.employees" 
                    (nzSortOrderChange)="sort('employees', $event)"
                    [nzSortDirections]="sortDirections"
                  >
                    Colaboradores
                  </th>
                  <th 
                    nzColumnKey="level" 
                    [nzSortOrder]="sortOrder.level" 
                    (nzSortOrderChange)="sort('level', $event)"
                    [nzSortDirections]="sortDirections"
                  >
                    Nivel
                  </th>
                  <th 
                    nzColumnKey="subdivisions" 
                    [nzSortOrder]="sortOrder.subdivisions" 
                    (nzSortOrderChange)="sort('subdivisions', $event)"
                    [nzSortDirections]="sortDirections"
                  >
                    Subdivisiones
                  </th>
                  <th 
                    nzColumnKey="ambassador" 
                    [nzSortOrder]="sortOrder.ambassador" 
                    (nzSortOrderChange)="sort('ambassador', $event)"
                    [nzSortDirections]="sortDirections"
                  >
                    Embajadores
                  </th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let division of divisionsTable.data">
                  <!-- Fila principal de la división -->
                  <tr>
                    <td>
                      <strong>{{ division.name }}</strong>
                    </td>
                    <td>
                      <span *ngIf="division.parent; else noParent">
                        {{ division.parent.name }}
                      </span>
                      <ng-template #noParent>
                        <span class="text-muted">--</span>
                      </ng-template>
                    </td>
                    <td>
                      <nz-tag [nzColor]="getEmployeeCountColor(division.employees.length || 0)">
                        {{ division.employees.length || 0 }}
                      </nz-tag>
                    </td>
                    <td>
                      <nz-tag [nzColor]="getLevelColor(division.level)">
                        Nivel {{ division.level }}
                      </nz-tag>
                    </td>
                    <td>
                      <div class="subdivision-cell">
                        <nz-tag [nzColor]="getSubdivisionCountColor(division.children.length || 0)">
                          {{ division.children.length || 0 }}
                        </nz-tag>

                        <!-- Botón para mostrar subdivisiones si las hay -->
                        <button
                          *ngIf="division.children && division.children.length > 0"
                          nz-button
                          nzType="text"
                          nzSize="small"
                          (click)="toggleSubdivisions(division)"
                          nz-tooltip="{{
                            division.showSubdivisions ? 'Ocultar' : 'Mostrar'
                          }} subdivisiones"
                          style="margin-left: 8px"
                        >
                          <span
                            nz-icon
                            [nzType]="division.showSubdivisions ? 'up' : 'down'"
                            nzTheme="outline"
                          ></span>
                        </button>
                      </div>
                    </td>
                    <td>
                      <span *ngIf="division.ambassador; else noAmbassador">
                        {{ division.ambassador.fullName }}
                      </span>
                      <ng-template #noAmbassador>
                        <span class="text-muted">Sin embajador</span>
                      </ng-template>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <button
                          nz-button
                          nzType="primary"
                          nzSize="small"
                          (click)="showEditModal(division)"
                          nz-tooltip="Editar división"
                          style="margin-right: 8px"
                        >
                          <span nz-icon nzType="edit" nzTheme="outline"></span>
                        </button>
                        <button
                          nz-button
                          nzType="primary"
                          nzDanger
                          nzSize="small"
                          (click)="confirmDeleteDivision(division)"
                          [nzLoading]="division.deleting"
                          nz-tooltip="Eliminar división"
                        >
                          <span nz-icon nzType="delete" nzTheme="outline"></span>
                        </button>
                      </div>
                    </td>
                  </tr>

                  <!-- Filas de subdivisiones (expandibles) -->
                  <tr
                    *ngFor="let child of division.children"
                    class="subdivision-row"
                    [style.display]="division.showSubdivisions ? 'table-row' : 'none'"
                  >
                    <td class="subdivision-name">
                      <span class="subdivision-indent">└─</span>
                      <strong>{{ child.name }}</strong>
                    </td>
                    <td>
                      <span class="subdivision-parent">{{ division.name }}</span>
                    </td>
                    <td>
                      <nz-tag nzColor="blue">
                        0
                        <!-- Las subdivisiones generalmente no tienen empleados directos -->
                      </nz-tag>
                    </td>
                    <td>
                      <nz-tag [nzColor]="getLevelColor(child.level)">
                        Nivel {{ child.level }}
                      </nz-tag>
                    </td>
                    <td>
                      <nz-tag nzColor="default">
                        0
                        <!-- Por simplicidad, no mostramos sub-subdivisiones por ahora -->
                      </nz-tag>
                    </td>
                    <td>
                      <span class="text-muted">--</span>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <button
                          nz-button
                          nzType="primary"
                          nzSize="small"
                          (click)="showEditModalForChild(child)"
                          nz-tooltip="Editar subdivisión"
                          style="margin-right: 8px"
                        >
                          <span nz-icon nzType="edit" nzTheme="outline"></span>
                        </button>
                        <button
                          nz-button
                          nzType="primary"
                          nzDanger
                          nzSize="small"
                          (click)="confirmDeleteChildDivision(child)"
                          [nzLoading]="child.deleting"
                          nz-tooltip="Eliminar subdivisión"
                        >
                          <span nz-icon nzType="delete" nzTheme="outline"></span>
                        </button>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </nz-table>
          </nz-card>
        </div>

        <!-- Organization Content -->
        <div *ngIf="selectedMenuItem === 'organization'" class="organization-content">
          <nz-card nzTitle="Gestión de Organización" class="organization-card">
            <div class="organization-placeholder">
              <span
                nz-icon
                nzType="apartment"
                nzTheme="outline"
                style="font-size: 48px; color: #ccc"
              ></span>
              <h3>Módulo de Organización</h3>
              <p>Aquí se mostrará la gestión de la estructura organizacional</p>
            </div>
          </nz-card>
        </div>
      </div>
    </div>
  </nz-content>

  <!-- Componente Modal para crear división -->
  <app-modal-create
    [isVisible]="isCreateModalVisible"
    [divisions]="divisions() || []"
    (visibilityChange)="onModalVisibilityChange($event)"
    (divisionCreated)="onDivisionCreated($event)"
  ></app-modal-create>

  <!-- Modal para editar división -->
  <nz-modal
    [(nzVisible)]="isEditModalVisible"
    nzTitle="Editar División"
    (nzOnCancel)="handleEditCancel()"
    (nzOnOk)="handleEditOk()"
    nzOkText="Actualizar"
    nzCancelText="Cancelar"
    [nzOkLoading]="editLoading"
  >
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="editDivisionForm" nzLayout="vertical" *ngIf="editDivisionForm">
        <!-- Nombre de la división -->
        <nz-form-item>
          <nz-form-label nzRequired>Nombre de la División</nz-form-label>
          <nz-form-control
            nzErrorTip="El nombre es requerido y debe tener al menos 3 caracteres y no superar 45 caracteres"
          >
            <input nz-input formControlName="name" placeholder="Ingrese el nombre de la división" />
          </nz-form-control>
        </nz-form-item>

        <!-- Nivel -->
        <nz-form-item>
          <nz-form-label nzRequired>Nivel</nz-form-label>
          <nz-form-control nzErrorTip="El nivel debe estar entre 1 y 5">
            <nz-select formControlName="level" nzPlaceHolder="Seleccione el nivel">
              <nz-option [nzValue]="1" nzLabel="Nivel 1"></nz-option>
              <nz-option [nzValue]="2" nzLabel="Nivel 2"></nz-option>
              <nz-option [nzValue]="3" nzLabel="Nivel 3"></nz-option>
              <nz-option [nzValue]="4" nzLabel="Nivel 4"></nz-option>
              <nz-option [nzValue]="5" nzLabel="Nivel 5"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <!-- División Padre -->
        <nz-form-item>
          <nz-form-label>División Padre</nz-form-label>
          <nz-form-control>
            <nz-select
              formControlName="parentId"
              nzPlaceHolder="Seleccione división padre (opcional)"
              nzAllowClear
            >
              <nz-option
                *ngFor="let division of getAvailableParentDivisions()"
                [nzValue]="division.id"
                [nzLabel]="division.name"
              >
              </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </form>
    </ng-container>
  </nz-modal>
</nz-layout>
